\IfFileExists{stacks-project.cls}{%
\documentclass{stacks-project}
}{%
\documentclass{amsart}
}

% The following AMS packages are automatically loaded with
% the amsart documentclass:
%\usepackage{amsmath}
%\usepackage{amssymb}
%\usepackage{amsthm}

% For dealing with references we use the comment environment
\usepackage{verbatim}
\newenvironment{reference}{\comment}{\endcomment}
%\newenvironment{reference}{}{}
\newenvironment{slogan}{\comment}{\endcomment}
\newenvironment{history}{\comment}{\endcomment}

% For commutative diagrams you can use
% \usepackage{amscd}
\usepackage[all]{xy}

% We use 2cell for 2-commutative diagrams.
\xyoption{2cell}
\UseAllTwocells

% To put source file link in headers.
% Change "template.tex" to "this_filename.tex"
% \usepackage{fancyhdr}
% \pagestyle{fancy}
% \lhead{}
% \chead{}
% \rhead{Source file: \url{template.tex}}
% \lfoot{}
% \cfoot{\thepage}
% \rfoot{}
% \renewcommand{\headrulewidth}{0pt}
% \renewcommand{\footrulewidth}{0pt}
% \renewcommand{\headheight}{12pt}

\usepackage{multicol}

% For cross-file-references
\usepackage{xr-hyper}

% Package for hypertext links:
\usepackage{hyperref}

% For any local file, say "hello.tex" you want to link to please
% use \externaldocument[hello-]{hello}
\externaldocument[introduction-]{introduction}
\externaldocument[conventions-]{conventions}
\externaldocument[sets-]{sets}
\externaldocument[categories-]{categories}
\externaldocument[topology-]{topology}
\externaldocument[sheaves-]{sheaves}
\externaldocument[sites-]{sites}
\externaldocument[stacks-]{stacks}
\externaldocument[fields-]{fields}
\externaldocument[algebra-]{algebra}
\externaldocument[brauer-]{brauer}
\externaldocument[homology-]{homology}
\externaldocument[derived-]{derived}
\externaldocument[simplicial-]{simplicial}
\externaldocument[more-algebra-]{more-algebra}
\externaldocument[smoothing-]{smoothing}
\externaldocument[modules-]{modules}
\externaldocument[sites-modules-]{sites-modules}
\externaldocument[injectives-]{injectives}
\externaldocument[cohomology-]{cohomology}
\externaldocument[sites-cohomology-]{sites-cohomology}
\externaldocument[dga-]{dga}
\externaldocument[dpa-]{dpa}
\externaldocument[hypercovering-]{hypercovering}
\externaldocument[schemes-]{schemes}
\externaldocument[constructions-]{constructions}
\externaldocument[properties-]{properties}
\externaldocument[morphisms-]{morphisms}
\externaldocument[coherent-]{coherent}
\externaldocument[divisors-]{divisors}
\externaldocument[limits-]{limits}
\externaldocument[varieties-]{varieties}
\externaldocument[topologies-]{topologies}
\externaldocument[descent-]{descent}
\externaldocument[perfect-]{perfect}
\externaldocument[more-morphisms-]{more-morphisms}
\externaldocument[flat-]{flat}
\externaldocument[groupoids-]{groupoids}
\externaldocument[more-groupoids-]{more-groupoids}
\externaldocument[etale-]{etale}
\externaldocument[chow-]{chow}
\externaldocument[intersection-]{intersection}
\externaldocument[pic-]{pic}
\externaldocument[adequate-]{adequate}
\externaldocument[dualizing-]{dualizing}
\externaldocument[duality-]{duality}
\externaldocument[discriminant-]{discriminant}
\externaldocument[local-cohomology-]{local-cohomology}
\externaldocument[curves-]{curves}
\externaldocument[resolve-]{resolve}
\externaldocument[models-]{models}
\externaldocument[pione-]{pione}
\externaldocument[etale-cohomology-]{etale-cohomology}
\externaldocument[proetale-]{proetale}
\externaldocument[crystalline-]{crystalline}
\externaldocument[spaces-]{spaces}
\externaldocument[spaces-properties-]{spaces-properties}
\externaldocument[spaces-morphisms-]{spaces-morphisms}
\externaldocument[decent-spaces-]{decent-spaces}
\externaldocument[spaces-cohomology-]{spaces-cohomology}
\externaldocument[spaces-limits-]{spaces-limits}
\externaldocument[spaces-divisors-]{spaces-divisors}
\externaldocument[spaces-over-fields-]{spaces-over-fields}
\externaldocument[spaces-topologies-]{spaces-topologies}
\externaldocument[spaces-descent-]{spaces-descent}
\externaldocument[spaces-perfect-]{spaces-perfect}
\externaldocument[spaces-more-morphisms-]{spaces-more-morphisms}
\externaldocument[spaces-flat-]{spaces-flat}
\externaldocument[spaces-groupoids-]{spaces-groupoids}
\externaldocument[spaces-more-groupoids-]{spaces-more-groupoids}
\externaldocument[bootstrap-]{bootstrap}
\externaldocument[spaces-pushouts-]{spaces-pushouts}
\externaldocument[groupoids-quotients-]{groupoids-quotients}
\externaldocument[spaces-more-cohomology-]{spaces-more-cohomology}
\externaldocument[spaces-simplicial-]{spaces-simplicial}
\externaldocument[spaces-duality-]{spaces-duality}
\externaldocument[formal-spaces-]{formal-spaces}
\externaldocument[restricted-]{restricted}
\externaldocument[spaces-resolve-]{spaces-resolve}
\externaldocument[formal-defos-]{formal-defos}
\externaldocument[defos-]{defos}
\externaldocument[cotangent-]{cotangent}
\externaldocument[examples-defos-]{examples-defos}
\externaldocument[algebraic-]{algebraic}
\externaldocument[examples-stacks-]{examples-stacks}
\externaldocument[stacks-sheaves-]{stacks-sheaves}
\externaldocument[criteria-]{criteria}
\externaldocument[artin-]{artin}
\externaldocument[quot-]{quot}
\externaldocument[stacks-properties-]{stacks-properties}
\externaldocument[stacks-morphisms-]{stacks-morphisms}
\externaldocument[stacks-limits-]{stacks-limits}
\externaldocument[stacks-cohomology-]{stacks-cohomology}
\externaldocument[stacks-perfect-]{stacks-perfect}
\externaldocument[stacks-introduction-]{stacks-introduction}
\externaldocument[stacks-more-morphisms-]{stacks-more-morphisms}
\externaldocument[stacks-geometry-]{stacks-geometry}
\externaldocument[moduli-]{moduli}
\externaldocument[moduli-curves-]{moduli-curves}
\externaldocument[examples-]{examples}
\externaldocument[exercises-]{exercises}
\externaldocument[guide-]{guide}
\externaldocument[desirables-]{desirables}
\externaldocument[coding-]{coding}
\externaldocument[obsolete-]{obsolete}
\externaldocument[fdl-]{fdl}
\externaldocument[index-]{index}

% Theorem environments.
%
\theoremstyle{plain}
\newtheorem{theorem}[subsection]{Theorem}
\newtheorem{proposition}[subsection]{Proposition}
\newtheorem{lemma}[subsection]{Lemma}

\theoremstyle{definition}
\newtheorem{definition}[subsection]{Definition}
\newtheorem{example}[subsection]{Example}
\newtheorem{exercise}[subsection]{Exercise}
\newtheorem{situation}[subsection]{Situation}

\theoremstyle{remark}
\newtheorem{remark}[subsection]{Remark}
\newtheorem{remarks}[subsection]{Remarks}

\numberwithin{equation}{subsection}

% Macros
%
\def\lim{\mathop{\rm lim}\nolimits}
\def\colim{\mathop{\rm colim}\nolimits}
\def\Spec{\mathop{\rm Spec}}
\def\Hom{\mathop{\rm Hom}\nolimits}
\def\Ext{\mathop{\rm Ext}\nolimits}
\def\SheafHom{\mathop{\mathcal{H}\!{\it om}}\nolimits}
\def\SheafExt{\mathop{\mathcal{E}\!{\it xt}}\nolimits}
\def\Sch{\textit{Sch}}
\def\Mor{\mathop{\rm Mor}\nolimits}
\def\Ob{\mathop{\rm Ob}\nolimits}
\def\Sh{\mathop{\textit{Sh}}\nolimits}
\def\NL{\mathop{N\!L}\nolimits}
\def\proetale{{pro\text{-}\acute{e}tale}}
\def\etale{{\acute{e}tale}}
\def\QCoh{\textit{QCoh}}
\def\Ker{\mathop{\rm Ker}}
\def\Im{\mathop{\rm Im}}
\def\Coker{\mathop{\rm Coker}}
\def\Coim{\mathop{\rm Coim}}

%
% Macros for moduli stacks/spaces
%
\def\QCohstack{\mathcal{QC}\!{\it oh}}
\def\Cohstack{\mathcal{C}\!{\it oh}}
\def\Spacesstack{\mathcal{S}\!{\it paces}}
\def\Quotfunctor{{\rm Quot}}
\def\Hilbfunctor{{\rm Hilb}}
\def\Curvesstack{\mathcal{C}\!{\it urves}}
\def\Polarizedstack{\mathcal{P}\!{\it olarized}}
\def\Complexesstack{\mathcal{C}\!{\it omplexes}}
% \Pic is the operator that assigns to X its picard group, usage \Pic(X)
% \Picardstack_{X/B} denotes the Picard stack of X over B
% \Picardfunctor_{X/B} denotes the Picard functor of X over B
\def\Pic{\mathop{\rm Pic}\nolimits}
\def\Picardstack{\mathcal{P}\!{\it ic}}
\def\Picardfunctor{{\rm Pic}}
\def\Deformationcategory{\mathcal{D}\!{\it ef}}
\def\CMfunctor{\text{CM}}



% OK, start here.
%
\begin{document}

\title{The CM functor}


\maketitle


\section{The (Honsen?) functor}
\label{section-cm}

\noindent
In this section we prove the (Honsen?) functor is an algebraic space.\\

\begin{situation}
\label{situation-cm}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic spaces
over $S$. Assume that $f$ is of separated and of finite presentation.
For any scheme $T$ over $B$ we will denote $X_T$ the base change
of $X$ to $T$. Given such a $T$ we set:
\begin{align*}
\CMfunctor_{X/B}(T) = & (h, C \to T, g)  \text{ where } 
h \text{ is a morphism } h : T \to B \text{ and } g \text{ is a morphism } g : C \to X \\ & \text{satisfying the following properties}
\end{align*}
\begin{enumerate}
\item The diagram below is commutative: 
$$
\xymatrix{
C \ar[r]_g \ar[d] & X \ar[d] \\
T \ar[r]^h & B
}
$$
\item $C$ is an algebraic space and $C \to T$ is a Cohen-Macauley morphism of relative dimension 1 which is flat, proper, and of finite presentation.
\item The induced morphism $(g?) : C \to X_T$ is finite
\item There is an open $U \subset X_T$ where
\begin{enumerate}
\item $(g?)^{-1}(U) \to U$ is a closed immersion
\item For every $t \in T$, the fiber
$\left((g?)^{-1}(U)\right)_t$ is dense in $C_t$
\end{enumerate}
\end{enumerate}
\end{situation}

Effectiveness of formal objects:
\\

\begin{theorem} Fix a complete Noetherian local $\mathcal{O}_S$-algebra $A$ and a collection of $\Spec A/m_i$ points of $CM_{X/B}$ for all $i$ which are compatible, call it $(h_i,C_i,g_i)$. Then there exists a $\Spec A$ point of $CM_{X/B}$ which restricts to $(h_i,C_i,g_i)$. 
\end{theorem}

\begin{proof}

We view the data of $(h,C, g)$ as a coherent algebra on $X_T$ by considering $(g_T)_*\mathcal{O}_{X_T}$. Conversely, given a coherent algebra $\mathcal{A}$ on $X_T$ that is $T$-flat with proper support over $T$, we take the relative spectrum of $\mathcal{A}$. Let $(h_i,C_i,g_i)$ be a compatible system of $\Spec A/m^n$ points of $CM_{X/B}$ and consider the corresponding coherent algebras $\mathcal{A}_i$ on $X_i=X \times_B  \Spec A/m^i$. 
\\

The underlying coherent sheaf and its algebra structure can be described by morphisms $\mathcal{A}_i \otimes \mathcal{A}_i \to \mathcal{A}_i$ and the unit $\mathcal{O}_{X_{A/m^i}} \to \mathcal{A}_i$. That this yields an algebra structure is expressed by the commutativity of certain diagrams. By Lemma 08BE these diagrams correspond to diagrams in $Coh_{X_A/\Spec A}$. As such we obtain a coherent algebra $\mathcal{A}$ on $X_A=X \times_B \Spec A$ whose relative spectrum is the candidate for algebraizing the formal point $(h_i,C_i,g_i)$ corresponding to $(\mathcal{A}_i)$. 
\\

It remains to show that $C=\underline{\Spec}_X(\mathcal{A})$ is a $\Spec A$-point of $CM_{X/B}$. Since it arises as the relative spectrum of a coherent algebra with proper support over $\Spec A$, $C \to X_{\Spec A}$ is finite with proper support of finite presentation over $\Spec A$. Since $C_i$ is $\Spec A/m^i$-flat for each $i$ Lemma 0523 shows $C$ is $\Spec A$-flat. To verify that $g_A: C \to X_A$ is a Cohen-Maucalay morphism use the fact that the closed fiber of $C \times_B \Spec A/m \to \Spec A/m$ is a Cohen-Maucalay morphism and Lemma 045U to conclude. To see that $C$ is a relative curve over $\Spec A$ apply Lemma 02NM, the fact that $C$ is proper over $\Spec A$, and that the closed fiber is relative dimension $1$. 
\\

It remains to show the locus where the morphism $C_T \to X_A$ is a closed immersion is dense on the fibers. Note that this locus is open as it can be identified with the complement of $\text{Supp}(\text{Coker}[O_{X_A} \to \mathcal{A}])$ and the latter is closed because it is the support of a coherent sheaf. Since pullback is right exact and taking supports is compatible with restriction to a closed subscheme (Lemma 00L3) we obtain 

\[\text{Supp}(\text{Coker}[O_{X_A} \to \mathcal{A}])|_{\Spec A/m}=\text{Supp}(\text{Coker}[O_{X_{A/m}} \to \mathcal{A}_0]))\]

and the latter is dense when pulled back to $C_0=C \times \Spec A/m$. This implies $g_A^{-1}(U)$ is dense in the closed fiber $C_0 \subset C$ and now we must conclude that it is dense in every fiber of $C$. Let $p \subset A$ be a prime ideal, by modding out and pulling back $g_A: C \to X_A$ we may suppose that $p=(0)$ is the generic point of $A$. 
\\

If there is a generic point of the generic fiber $\eta \in C \times_B \Spec A_{(0)}$ not in $g_A^{-1}(U)$ then the closure $\overline{\{\eta\}}$ is disjoint from $g_A^{-1}(U)$. Consider the composition $Y=\overline{\{\eta\}} \subset X_A \to \Spec A$ where $Y$ has the reduced induced structure. Then by Lemma 02FZ the set $U_0=\{y \in Y|\dim_y Y_{f(y)} = 0 \}$ is open in $Y$. Since $g_A^{-1}(U)$ contains all generic points of the closed fiber the closed fiber of $Y$ must have dimension $<1$. It follows that $U_0$ contains all of $Y \times_B \Spec {A/m}$ and therefore $Y \subset U_0$. Indeed, if $y \in Y$ then its closure must have a point in $Y \times \Spec A/m^i$ because $Y \to \Spec A$ is proper and $A$ is local. This contradicts the fact that $C \to \Spec A$ is a relative curve. It follows that $g_A^{-1}(U)$ contains all the generic points of the generic fiber, as desired. It follows that the resulting $g_A: C \to X_A$ is a $A$-point of $CM_{X/B}$ which algebraizes $(h_i,C_i,g_i)$. 

\end{proof}

Strong Effectiveness

Let $(A_n)$ be a inverse system of rings with surjective transition maps which have locally nilpotent kernels. Take $A=\lim A_n$, to show the strong form of formal effectiveness we prove that if $CM_{X/B}$ admits a compatible system of $\Spec A_n$-points, $\zeta_n \in CM_{X/B}(\Spec A_n)$, then it admits a $\Spec A$-point $\zeta \in CM_{X/B}(\Spec A)$ which extends the $(\zeta_n)$. 

\begin{theorem} Let $A=\lim A_n$ and $(\zeta_n)$ be as above. Then there exists a $\zeta \in CM_{X/B}(\Spec A)$ which extends the $(\zeta_n)$. 
\end{theorem}

We view the data of $(h,C, g) \in CM_{X/B}(T)$ as a quasicoherent algebra of finite presentation (as a $\mathcal{O}_T$-module) on $X_T$ by considering $(g_T)_*\mathcal{O}_{X_T}$. Conversely, given a quasicoherent algebra of finite presentation $\mathcal{A}$ on $X_T$ that is $T$-flat with proper support over $T$, we take the relative spectrum of $\mathcal{A}$. Let $(h_i,C_i,g_i)$ be a compatible system of $\Spec A_n$ points of $CM_{X/B}$ and consider the corresponding quasicoherent algebras $\mathcal{A}_i$ on $X_i=X \times_B  \Spec A_i$.
\\

First we algebraize the underlying quasicoherent module structure of the $(\mathcal{A}_n)$ to $\Spec A$ using Lemma 0CXB, call the resulting quasicoherent sheaf $\mathcal{A}$. It is flat over $\Spec A$, of finite presentation and has proper support over $\Spec A$. Next we will lift the algebra structure i.e. we need a $\Spec A$ point, $(m,u)$ of $Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{O}_{X_A},\mathcal{A})$ which yields a multiplication and a section which are commutative, associative and so that the section behaves as a unit element with respect to this multiplication. 

That $(m,u)$ yields an algebra structure is expressed by the commutativity of certain diagrams whose arrows naturally depend only on the choice of multiplication and unit e.g. associativity is described as two different morphisms 
\[m \circ (m \otimes 1), m \circ (1 \otimes m): \mathcal{A} \otimes \mathcal{A} \otimes \mathcal{A} \to \mathcal{A}\]
being equal. Given a map $\Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A})$ these are two ways to get a map in $Hom(\mathcal{A} \otimes \mathcal{A} \otimes \mathcal{A}, \mathcal{A})$. i.e. we have a morphism of sheaves
\[Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \to Hom(\mathcal{A} \otimes \mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{A} \otimes \mathcal{A} \otimes \mathcal{A}, \mathcal{A})\]
and the pullback of the diagonal is a closed locus which consists of those maps $\mathcal{A} \otimes \mathcal{A} \to \mathcal{A}$ satisfying the associativity law. 
\\

By the exact same argument, the other diagrams which express the fact that a map $\mathcal{A} \otimes \mathcal{A} \to \mathcal{A}$ is an algebra-map also introduce a closed condition (scheme-theoretically) in $Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{O},\mathcal{A})$. Details omitted. 
\\

The scheme-theoretic intersection of these closed subschemes is exactly the locus of $Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{O},\mathcal{A})$ consisting of multiplication maps and units turning $\mathcal{A}$ into a algebra, call it $Y_{alg}$. 
\\

Since $\mathcal{A}|_{X_{\Spec A_n}}$ has algebra structures for every $n$ these give us $\Spec A_n$ points of $Y_{alg} \subset Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{O},\mathcal{A})$. By Lemma 08JT we know $Hom(\mathcal{A} \otimes \mathcal{A}, \mathcal{A}) \times Hom(\mathcal{O},\mathcal{A})$ and therefore $Y_{alg}$ is affine. So because we have compatible maps $H^0(Y_{alg},\mathcal{O}_{Y_{alg}}) \to A_n$ for every $n$ they factor as $H^0(Y_{alg},\mathcal{O}_{Y_{alg}}) \to A = \lim A_n \to  A_n$ and so we obtain $\Spec A_n \to \Spec A \to Y_{alg}$. Unwinding this, this says there is a unique lift of the algebra structure on $\mathcal{A}$ from that of the $\mathcal{A}_n$. 
\\

It remains to show that $C=\underline{\Spec}_X(\mathcal{A})$ is a $\Spec A$-point of $CM_{X/B}$. Since it arises as the relative spectrum of a finitely presented quasicoherent algebra which is $\Spec A$-flat with proper support over $\Spec A$, $C \to X_{\Spec A}$ is finite with proper support of finite presentation over $\Spec A$. Let $A \to A_0$ be natural map, it is surjective with kernel $I \subset A$. By Lemma 0CT7 we know that $I$ is a radical ideal, i.e. it is contained in all the maximal ideals of $A$. To verify that $g_A: C \to X_A$ is a Cohen-Maucalay morphism use the fact that the fiber product of $C \times_B \Spec A_0 \to \Spec A_0$ is a Cohen-Maucalay morphism and Lemma 045U to conclude. To see that $C$ is a relative curve over $\Spec A$ apply Lemma 02NM, the fact that $C$ is proper over $\Spec A$, and that the fiber product $C \times_A \Spec A/I$ is relative dimension $1$ over $\Spec A/I$. 
\\

To finish we shall show the locus where the morphism $C \to X_A$ is a closed immersion is dense on the fibers. Note that this locus is open as it can be identified with the complement of $\text{Supp}(\text{Coker}[O_{X_A} \to \mathcal{A}])$ and the latter is closed because it is the support of a finitely presented quasicoherent sheaf. Since pullback is right exact and taking supports is compatible with restriction to a closed subscheme (Lemma 00L3) we obtain 

\[\text{Supp}(\text{Coker}[O_{X_A} \to \mathcal{A}])|_{\Spec A/I}=\text{Supp}(\text{Coker}[O_{X_{A/I}} \to \mathcal{A}_0]))\]

and the latter is dense when pulled back to $C_0=C \times \Spec A/I$. This implies $g_A^{-1}(U)$ is dense in the closed fiber $C_0 \subset C$ and now we must conclude that it is dense in every fiber of $C$. Let $p \subset A$ be a prime ideal, by modding out and pulling back $g_A: C \to X_A$ we may suppose that $p=(0)$ is the generic point of $A$. 
\\

If there is a generic point of the generic fiber $\eta \in C \times_B \Spec A_{(0)}$ not in $g_A^{-1}(U)$ then the closure $\overline{\{\eta\}}$ is disjoint from $g_A^{-1}(U)$. Consider the composition $Y=\overline{\{\eta\}} \subset X_A \to \Spec A$ where $Y$ has the reduced induced structure. Then by Lemma 02FZ the set $U_0=\{y \in Y|\dim_y Y_{f(y)} = 0 \}$ is open in $Y$. Since $g_A^{-1}(U)$ contains all generic points of the closed fiber the closed fiber of $Y$ must have dimension $<1$. It follows that $U_0$ contains all of $Y \times_B \Spec {A/I}$ and therefore $Y \subset U_0$ because $\Spec A/I$ contains all closed points of $\Spec A$. This contradicts the fact that $C \to \Spec A$ is a relative curve. It follows that $g_A^{-1}(U)$ contains all the generic points of the generic fiber, as desired. It follows that the resulting $g_A: C \to X_A$ is a $A$-point of $CM_{X/B}$ which algebraizes $(h_i,C_i,g_i)$. 



\end{document}